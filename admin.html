<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>LinguaXYZ Admin</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.1/chart.umd.min.js"></script>
<style>
  @import url('https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;500;600;700&family=Outfit:wght@300;400;500;600;700&display=swap');

  :root {
    --bg: #0c0c10; --surface: #16161d; --surface2: #1e1e28;
    --border: #2a2a38; --text: #e4e4ed; --muted: #8888a0;
    --accent: #7c5cfc; --accent2: #4ecdc4; --red: #ff6b6b;
    --green: #51cf66; --yellow: #ffd43b; --blue: #4dabf7;
  }

  * { margin: 0; padding: 0; box-sizing: border-box; }
  body { font-family: 'Outfit', sans-serif; background: var(--bg); color: var(--text); min-height: 100vh; }

  .mono { font-family: 'JetBrains Mono', monospace; }

  /* Login */
  #login {
    display: flex; align-items: center; justify-content: center; min-height: 100vh;
    background: radial-gradient(ellipse at 50% 30%, rgba(124,92,252,0.08), transparent 60%);
  }
  .login-card {
    background: var(--surface); border: 1px solid var(--border); border-radius: 16px;
    padding: 48px; width: 380px; text-align: center;
  }
  .login-card h1 { font-size: 22px; font-weight: 600; margin-bottom: 8px; }
  .login-card p { color: var(--muted); font-size: 14px; margin-bottom: 28px; }
  .login-card input {
    width: 100%; padding: 12px 16px; background: var(--bg); border: 1px solid var(--border);
    border-radius: 10px; color: var(--text); font-size: 14px; font-family: 'JetBrains Mono', monospace;
    outline: none; margin-bottom: 16px; text-align: center; letter-spacing: 1px;
  }
  .login-card input:focus { border-color: var(--accent); }
  .login-card button {
    width: 100%; padding: 12px; background: var(--accent); border: none; border-radius: 10px;
    color: white; font-size: 14px; font-weight: 600; cursor: pointer; transition: .2s;
  }
  .login-card button:hover { filter: brightness(1.15); }
  .login-error { color: var(--red); font-size: 13px; margin-top: 12px; }

  /* Layout */
  #app { display: none; }
  .topbar {
    position: sticky; top: 0; z-index: 50; padding: 16px 32px;
    background: rgba(12,12,16,0.85); backdrop-filter: blur(16px);
    border-bottom: 1px solid var(--border);
    display: flex; align-items: center; justify-content: space-between;
  }
  .topbar h1 { font-size: 18px; font-weight: 600; }
  .topbar .meta { color: var(--muted); font-size: 13px; }
  .topbar .refresh { background: var(--surface2); border: 1px solid var(--border); color: var(--text);
    padding: 8px 16px; border-radius: 8px; cursor: pointer; font-size: 13px; font-weight: 500; }
  .topbar .refresh:hover { border-color: var(--accent); }

  .container { max-width: 1280px; margin: 0 auto; padding: 24px 32px; }

  /* Stat cards */
  .stats { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px; margin-bottom: 28px; }
  .stat {
    background: var(--surface); border: 1px solid var(--border); border-radius: 12px;
    padding: 20px; position: relative; overflow: hidden;
  }
  .stat::before {
    content: ''; position: absolute; top: 0; left: 0; right: 0; height: 3px;
    background: linear-gradient(90deg, var(--accent), var(--accent2));
  }
  .stat .label { font-size: 12px; color: var(--muted); text-transform: uppercase; letter-spacing: 1px; font-weight: 500; }
  .stat .value { font-size: 28px; font-weight: 700; margin: 8px 0 2px; letter-spacing: -0.5px; }
  .stat .sub { font-size: 12px; color: var(--muted); }

  /* Charts */
  .charts { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 28px; }
  .chart-card {
    background: var(--surface); border: 1px solid var(--border); border-radius: 12px;
    padding: 24px;
  }
  .chart-card h3 { font-size: 14px; font-weight: 600; margin-bottom: 16px; color: var(--muted); text-transform: uppercase; letter-spacing: 0.5px; }
  .chart-card canvas { width: 100% !important; height: 220px !important; }

  /* Tables */
  .table-card {
    background: var(--surface); border: 1px solid var(--border); border-radius: 12px;
    padding: 24px; margin-bottom: 28px; overflow-x: auto;
  }
  .table-card h3 {
    font-size: 14px; font-weight: 600; margin-bottom: 16px;
    color: var(--muted); text-transform: uppercase; letter-spacing: 0.5px;
    display: flex; align-items: center; justify-content: space-between;
  }
  .table-card h3 .count { background: var(--surface2); padding: 2px 10px; border-radius: 20px; font-size: 12px; color: var(--text); }
  table { width: 100%; border-collapse: collapse; }
  th { text-align: left; padding: 10px 12px; font-size: 11px; color: var(--muted); text-transform: uppercase;
    letter-spacing: 1px; font-weight: 600; border-bottom: 1px solid var(--border); }
  td { padding: 12px; font-size: 13px; border-bottom: 1px solid rgba(42,42,56,0.5); }
  tr:hover td { background: rgba(124,92,252,0.03); }
  .badge {
    display: inline-block; padding: 2px 8px; border-radius: 6px; font-size: 11px;
    font-weight: 600; font-family: 'JetBrains Mono', monospace;
  }
  .badge-green { background: rgba(81,207,102,0.12); color: var(--green); }
  .badge-yellow { background: rgba(255,212,59,0.12); color: var(--yellow); }
  .badge-red { background: rgba(255,107,107,0.12); color: var(--red); }
  .badge-blue { background: rgba(77,171,247,0.12); color: var(--blue); }

  /* Actions */
  .action-btn {
    background: var(--surface2); border: 1px solid var(--border); color: var(--text);
    padding: 4px 10px; border-radius: 6px; cursor: pointer; font-size: 12px; transition: .2s;
  }
  .action-btn:hover { border-color: var(--accent); color: var(--accent); }

  /* Modal */
  .modal-overlay {
    position: fixed; inset: 0; background: rgba(0,0,0,0.6); backdrop-filter: blur(4px);
    display: flex; align-items: center; justify-content: center; z-index: 100;
  }
  .modal {
    background: var(--surface); border: 1px solid var(--border); border-radius: 16px;
    padding: 32px; width: 400px;
  }
  .modal h3 { font-size: 16px; margin-bottom: 16px; }
  .modal input {
    width: 100%; padding: 10px 14px; background: var(--bg); border: 1px solid var(--border);
    border-radius: 8px; color: var(--text); font-size: 14px; outline: none; margin-bottom: 12px;
    font-family: 'JetBrains Mono', monospace;
  }
  .modal input:focus { border-color: var(--accent); }
  .modal-actions { display: flex; gap: 8px; justify-content: flex-end; margin-top: 8px; }
  .modal-actions button {
    padding: 8px 20px; border-radius: 8px; border: none; font-size: 13px; font-weight: 600; cursor: pointer;
  }
  .modal-actions .cancel { background: var(--surface2); color: var(--text); border: 1px solid var(--border); }
  .modal-actions .confirm { background: var(--accent); color: white; }

  @media (max-width: 768px) {
    .charts { grid-template-columns: 1fr; }
    .stats { grid-template-columns: repeat(2, 1fr); }
    .container { padding: 16px; }
    .topbar { padding: 12px 16px; }
  }
</style>
</head>
<body>

<!-- LOGIN SCREEN -->
<div id="login">
  <div class="login-card">
    <h1>ðŸ”’ LinguaXYZ Admin</h1>
    <p>Enter your admin secret to continue</p>
    <input id="secret-input" type="password" placeholder="Admin Secret" autofocus>
    <button onclick="doLogin()">Authenticate</button>
    <div id="login-error" class="login-error" style="display:none"></div>
  </div>
</div>

<!-- MAIN APP -->
<div id="app">
  <div class="topbar">
    <div>
      <h1>ðŸ“Š LinguaXYZ Admin</h1>
      <div class="meta" id="uptime"></div>
    </div>
    <div style="display:flex;gap:8px;align-items:center">
      <div class="meta" id="last-refresh"></div>
      <button class="refresh" onclick="loadAll()">â†» Refresh</button>
    </div>
  </div>

  <div class="container">
    <!-- Stats -->
    <div class="stats" id="stats-grid"></div>

    <!-- Charts -->
    <div class="charts">
      <div class="chart-card"><h3>Daily Signups</h3><canvas id="chart-signups"></canvas></div>
      <div class="chart-card"><h3>Daily Messages</h3><canvas id="chart-messages"></canvas></div>
      <div class="chart-card"><h3>Daily Token Usage</h3><canvas id="chart-tokens"></canvas></div>
      <div class="chart-card"><h3>Daily Referrals</h3><canvas id="chart-referrals"></canvas></div>
    </div>

    <!-- Users -->
    <div class="table-card">
      <h3>Users <span class="count" id="user-count">0</span></h3>
      <table>
        <thead><tr>
          <th>Name</th><th>Telegram ID</th><th>Balance</th><th>Used</th>
          <th>Referrals</th><th>Joined</th><th>Actions</th>
        </tr></thead>
        <tbody id="users-table"></tbody>
      </table>
    </div>

    <!-- Chats -->
    <div class="table-card">
      <h3>Chats <span class="count" id="chat-count">0</span></h3>
      <table>
        <thead><tr>
          <th>Chat Name</th><th>Type</th><th>Languages</th><th>Messages</th><th>Created</th>
        </tr></thead>
        <tbody id="chats-table"></tbody>
      </table>
    </div>

    <!-- Purchases -->
    <div class="table-card" id="purchases-section" style="display:none">
      <h3>Purchases <span class="count" id="purchase-count">0</span></h3>
      <table>
        <thead><tr>
          <th>User</th><th>Amount</th><th>Tokens</th><th>Status</th><th>Date</th>
        </tr></thead>
        <tbody id="purchases-table"></tbody>
      </table>
    </div>
  </div>
</div>

<!-- Token Modal -->
<div id="modal" class="modal-overlay" style="display:none">
  <div class="modal">
    <h3 id="modal-title">Add Tokens</h3>
    <p style="font-size:13px;color:var(--muted);margin-bottom:12px" id="modal-desc"></p>
    <input id="modal-input" type="number" placeholder="Token amount">
    <div class="modal-actions">
      <button class="cancel" onclick="closeModal()">Cancel</button>
      <button class="confirm" id="modal-confirm">Confirm</button>
    </div>
  </div>
</div>

<script>
const API = 'https://api.nhomnhom.com';
let secret = '';
let charts = {};

function fmt(n) {
  if (!n || n === 0) return '0';
  if (n >= 1000000) return (n/1000000).toFixed(1)+'M';
  if (n >= 1000) return (n/1000).toFixed(1)+'k';
  return String(n);
}

function fmtDate(d) {
  if (!d) return 'â€”';
  return new Date(d).toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
}

function fmtFull(d) {
  if (!d) return 'â€”';
  return new Date(d).toLocaleString('en-US', { month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit' });
}

function balanceBadge(b) {
  if (b <= 0) return `<span class="badge badge-red">${fmt(b)}</span>`;
  if (b < 1000) return `<span class="badge badge-yellow">${fmt(b)}</span>`;
  return `<span class="badge badge-green">${fmt(b)}</span>`;
}

async function apiFetch(path, opts = {}) {
  const res = await fetch(API + path, {
    ...opts,
    headers: { 'Content-Type': 'application/json', 'X-Admin-Secret': secret, ...opts.headers },
  });
  if (!res.ok) throw new Error(`${res.status}: ${res.statusText}`);
  return res.json();
}

// Login
async function doLogin() {
  secret = document.getElementById('secret-input').value.trim();
  const err = document.getElementById('login-error');
  if (!secret) { err.textContent = 'Enter a secret'; err.style.display = 'block'; return; }
  try {
    await apiFetch('/api/admin/users');
    localStorage.setItem('admin_secret', secret);
    document.getElementById('login').style.display = 'none';
    document.getElementById('app').style.display = 'block';
    loadAll();
  } catch (e) {
    err.textContent = 'Invalid secret';
    err.style.display = 'block';
  }
}

document.getElementById('secret-input').addEventListener('keydown', e => { if (e.key === 'Enter') doLogin(); });

// Auto-login
(function() {
  const saved = localStorage.getItem('admin_secret');
  if (saved) {
    secret = saved;
    document.getElementById('login').style.display = 'none';
    document.getElementById('app').style.display = 'block';
    loadAll();
  }
})();

// Load everything
async function loadAll() {
  try {
    const [usersData, chatsData, statsData, health] = await Promise.all([
      apiFetch('/api/admin/users'),
      apiFetch('/api/admin/chats'),
      apiFetch('/api/admin/stats'),
      fetch(API + '/health').then(r => r.json()),
    ]);

    renderStats(usersData.users, chatsData.chats, statsData, health);
    renderCharts(statsData);
    renderUsers(usersData.users);
    renderChats(chatsData.chats);
    renderPurchases(statsData.purchases || []);

    document.getElementById('uptime').textContent = `Uptime: ${Math.floor(health.uptime/3600)}h ${Math.floor((health.uptime%3600)/60)}m`;
    document.getElementById('last-refresh').textContent = `Updated ${new Date().toLocaleTimeString()}`;
  } catch (e) {
    console.error('Load failed:', e);
    if (e.message.includes('401')) {
      localStorage.removeItem('admin_secret');
      location.reload();
    }
  }
}

function renderStats(users, chats, stats, health) {
  const totalTokens = users.reduce((s, u) => s + (u.tokens_used || 0), 0);
  const totalBalance = users.reduce((s, u) => s + (u.balance || 0), 0);
  const totalRefs = users.reduce((s, u) => s + (u.referrals || 0), 0);

  // Estimate cost (~$0.026 per 10k tokens)
  const estCost = (totalTokens / 10000 * 0.026).toFixed(2);

  const grid = document.getElementById('stats-grid');
  grid.innerHTML = `
    <div class="stat"><div class="label">Total Users</div><div class="value">${users.length}</div><div class="sub">${stats.activeUsersLast7Days} active last 7d</div></div>
    <div class="stat"><div class="label">Messages Translated</div><div class="value">${fmt(stats.totalMessages)}</div><div class="sub">${chats.length} chats</div></div>
    <div class="stat"><div class="label">Tokens Used</div><div class="value">${fmt(totalTokens)}</div><div class="sub">~$${estCost} API cost</div></div>
    <div class="stat"><div class="label">Tokens Remaining</div><div class="value">${fmt(totalBalance)}</div><div class="sub">across all users</div></div>
    <div class="stat"><div class="label">Referrals</div><div class="value">${totalRefs}</div><div class="sub">${fmt(totalRefs * 10000)} tokens given</div></div>
    <div class="stat"><div class="label">Revenue</div><div class="value">$${(stats.totalRevenue / 100).toFixed(2)}</div><div class="sub">${stats.purchases?.length || 0} purchases</div></div>
  `;
}

function makeChart(id, labels, datasets, type = 'bar') {
  if (charts[id]) charts[id].destroy();
  const ctx = document.getElementById(id).getContext('2d');
  charts[id] = new Chart(ctx, {
    type,
    data: { labels, datasets },
    options: {
      responsive: true, maintainAspectRatio: false,
      plugins: { legend: { display: datasets.length > 1, labels: { color: '#8888a0', font: { size: 11 } } } },
      scales: {
        x: { ticks: { color: '#8888a0', font: { size: 10 } }, grid: { color: 'rgba(42,42,56,0.4)' } },
        y: { beginAtZero: true, ticks: { color: '#8888a0', font: { size: 10 } }, grid: { color: 'rgba(42,42,56,0.4)' } },
      },
    },
  });
}

function renderCharts(stats) {
  // Fill missing days
  const days = [];
  for (let i = 29; i >= 0; i--) {
    const d = new Date(); d.setDate(d.getDate() - i);
    days.push(d.toISOString().split('T')[0]);
  }
  const labels = days.map(d => { const dt = new Date(d); return `${dt.getMonth()+1}/${dt.getDate()}`; });

  function fill(arr, key = 'count') {
    const map = Object.fromEntries((arr||[]).map(r => [r.day, r[key]]));
    return days.map(d => map[d] || 0);
  }

  makeChart('chart-signups', labels, [{
    label: 'Signups', data: fill(stats.signups),
    backgroundColor: 'rgba(124,92,252,0.6)', borderColor: 'rgba(124,92,252,1)', borderWidth: 1, borderRadius: 4,
  }]);

  makeChart('chart-messages', labels, [{
    label: 'Messages', data: fill(stats.usage, 'messages'),
    backgroundColor: 'rgba(78,205,196,0.6)', borderColor: 'rgba(78,205,196,1)', borderWidth: 1, borderRadius: 4,
  }]);

  makeChart('chart-tokens', labels, [{
    label: 'Tokens', data: fill(stats.usage, 'tokens'),
    backgroundColor: 'rgba(255,212,59,0.5)', borderColor: 'rgba(255,212,59,1)', borderWidth: 1, borderRadius: 4,
  }]);

  makeChart('chart-referrals', labels, [{
    label: 'Referrals', data: fill(stats.referrals),
    backgroundColor: 'rgba(255,107,107,0.5)', borderColor: 'rgba(255,107,107,1)', borderWidth: 1, borderRadius: 4,
  }]);
}

function renderUsers(users) {
  document.getElementById('user-count').textContent = users.length;
  const tbody = document.getElementById('users-table');
  tbody.innerHTML = users.map(u => `
    <tr>
      <td><strong>${esc(u.name || 'â€”')}</strong></td>
      <td class="mono" style="font-size:12px;color:var(--muted)">${u.telegram_id || 'â€”'}</td>
      <td>${balanceBadge(u.balance)}</td>
      <td class="mono" style="font-size:12px">${fmt(u.tokens_used)}</td>
      <td>${u.referrals > 0 ? `<span class="badge badge-blue">${u.referrals}</span>` : '<span style="color:var(--muted)">0</span>'}</td>
      <td style="font-size:12px;color:var(--muted)">${fmtDate(u.created_at)}</td>
      <td>
        <button class="action-btn" onclick="openAddTokens('${u.id}','${esc(u.name)}')">+ Tokens</button>
      </td>
    </tr>
  `).join('');
}

function renderChats(chats) {
  document.getElementById('chat-count').textContent = chats.length;
  const tbody = document.getElementById('chats-table');
  tbody.innerHTML = chats.map(c => {
    let pairs = 'â€”';
    try {
      pairs = JSON.parse(c.language_pairs).map(([f,t]) => `${f}â†’${t}`).join(', ');
    } catch {}
    const typeBadge = c.chat_type === 'private' ? '<span class="badge badge-blue">DM</span>' : '<span class="badge badge-green">Group</span>';
    return `
      <tr>
        <td><strong>${esc(c.chat_name || 'â€”')}</strong></td>
        <td>${typeBadge}</td>
        <td class="mono" style="font-size:12px">${pairs}</td>
        <td class="mono">${c.total_messages}</td>
        <td style="font-size:12px;color:var(--muted)">${fmtDate(c.created_at)}</td>
      </tr>
    `;
  }).join('');
}

function renderPurchases(purchases) {
  if (purchases.length === 0) { document.getElementById('purchases-section').style.display = 'none'; return; }
  document.getElementById('purchases-section').style.display = 'block';
  document.getElementById('purchase-count').textContent = purchases.length;
  const tbody = document.getElementById('purchases-table');
  tbody.innerHTML = purchases.map(p => `
    <tr>
      <td><strong>${esc(p.name || 'â€”')}</strong></td>
      <td class="mono">$${(p.amount_cents/100).toFixed(2)}</td>
      <td class="mono">${fmt(p.tokens_granted)}</td>
      <td><span class="badge badge-green">${p.status}</span></td>
      <td style="font-size:12px;color:var(--muted)">${fmtFull(p.created_at)}</td>
    </tr>
  `).join('');
}

// Modal
let modalUserId = null;
function openAddTokens(userId, name) {
  modalUserId = userId;
  document.getElementById('modal-title').textContent = `Add Tokens â€” ${name}`;
  document.getElementById('modal-desc').textContent = `Enter the number of tokens to add to ${name}'s balance.`;
  document.getElementById('modal-input').value = '';
  document.getElementById('modal').style.display = 'flex';
  document.getElementById('modal-input').focus();
  document.getElementById('modal-confirm').onclick = confirmAddTokens;
}

function closeModal() {
  document.getElementById('modal').style.display = 'none';
  modalUserId = null;
}

async function confirmAddTokens() {
  const tokens = parseInt(document.getElementById('modal-input').value);
  if (!tokens || tokens <= 0) return;
  try {
    await apiFetch('/api/admin/add-tokens', {
      method: 'POST',
      body: JSON.stringify({ userId: modalUserId, tokens }),
    });
    closeModal();
    loadAll();
  } catch (e) {
    alert('Failed: ' + e.message);
  }
}

document.getElementById('modal-input').addEventListener('keydown', e => { if (e.key === 'Enter') confirmAddTokens(); });
document.getElementById('modal').addEventListener('click', e => { if (e.target === document.getElementById('modal')) closeModal(); });

function esc(s) { const d = document.createElement('div'); d.textContent = s; return d.innerHTML; }

// Auto-refresh every 60s
setInterval(loadAll, 60000);
</script>
</body>
</html>
